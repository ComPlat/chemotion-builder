FROM base as converter-base
ARG CONVERTER_BUILD_TAG

RUN apt-get update && \
    apt-get install -y --no-install-recommends python3-pip python3-venv libmagic1

# Stage: build the app
FROM converter-base as converter
ARG CONVERTER_BUILD_TAG
ARG SRVDIR=/srv/chemotion

WORKDIR ${SRVDIR}
ADD https://github.com/ComPlat/chemotion-converter-app/archive/refs/tags/${CONVERTER_BUILD_TAG}.tar.gz /tmp/code.tar.gz
RUN tar -xzf /tmp/code.tar.gz --strip-components=1 -C ${SRVDIR} && rm /tmp/code.tar.gz && \
    python3 -m venv env && . env/bin/activate && \
    pip install -r ${SRVDIR}/requirements/common.txt

ENV PATH=${SRVDIR}/env/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin \
    VIRTUAL_ENV=${SRVDIR}/env

EXPOSE 8000
CMD gunicorn --bind 0.0.0.0 'converter_app.app:create_app()' --preload
